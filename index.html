<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jaipur Auction Finder</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root { --border:#e9e9e9; --muted:#666; --brand:#1a73e8; }
  * { box-sizing: border-box; }
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111}
  header{padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:10}
  .title{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .muted{color:var(--muted);font-size:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  input,select,button{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
  button{cursor:pointer}
  #map{height:58vh}
  .meta{display:flex;gap:10px;align-items:center;padding:8px 16px;color:#333}
  .pill{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:#fff}
  .list{padding:10px 16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.03)}
  .badge{font-size:12px;border:1px solid var(--border);padding:2px 6px;border-radius:6px;margin-left:6px}
  footer{padding:20px 16px;color:#444;font-size:13px}
  a{text-decoration:none;color:var(--brand)}
</style>
</head>
<body>

<header>
  <div class="title">
    <h3 style="margin:0">Jaipur Auction Finder</h3>
    <div id="updated" class="muted"></div>
  </div>

  <div class="controls">
    <input id="q" placeholder="Search locality / bank / type"/>
    <select id="locality"><option value="">All Localities</option></select>
    <select id="type">
      <option value="">All Types</option>
      <option>Flat</option><option>Plot</option><option>House</option>
      <option>Commercial</option><option>Land</option>
    </select>
    <select id="priceBand">
      <option value="">Any Price</option>
      <option value="0-2500000">≤ 25L</option>
      <option value="2500000-5000000">25–50L</option>
      <option value="5000000-10000000">50L–1Cr</option>
      <option value="10000000-999000000">≥ 1Cr</option>
    </select>
    <button id="go">Search</button>
    <button id="reset">Reset</button>
  </div>
</header>

<div id="map"></div>
<div class="meta">
  <span id="count" class="pill">0 results</span>
</div>
<div class="list" id="list"></div>

<footer>
  Listings are fetched from public sources and linked to the original notice. Bank auctions are typically on “AS-IS-WHERE-IS / AS-IS-WHAT-IS” basis; verify title, dues and possession independently.
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
window.addEventListener('DOMContentLoaded', ()=>{
  // ---------------- Map ----------------
  const map = L.map('map').setView([26.9124, 75.7873], 11);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);
  const markersLayer = L.layerGroup().addTo(map);

  // ---------------- Elements ----------------
  const elQ = document.getElementById('q');
  const elLoc = document.getElementById('locality');
  const elType = document.getElementById('type');
  const elPrice = document.getElementById('priceBand');
  const elList = document.getElementById('list');
  const elGo = document.getElementById('go');
  const elReset = document.getElementById('reset');
  const elCount = document.getElementById('count');
  const elUpdated = document.getElementById('updated');

  // A broad curated list of Jaipur colonies/areas (add more anytime)
  const JAIPUR_COLONIES = [
    "Amer","Ashok Nagar","Bais Godam","Bani Park","Bapu Nagar","C-Scheme","Chitrakoot","Durgapura",
    "Gopalpura","Gopalpura Bypass","Jagatpura","JLN Marg","Jhotwara","Jawahar Nagar","Lal Kothi",
    "Malviya Nagar","Mansarovar","MI Road","Muralipura","Niwaru Road","Pratap Nagar","Queens Road",
    "Raja Park","Sanganer","Sikar Road","Sitapura","Sodala","Tonk Road","Vaishali Nagar",
    "Vidhyadhar Nagar","VKI","Ajmer Road","Bais Godam","Brahmpuri","Civil Lines","Hathoj",
    "Gandhi Path","Heerawala","Kalwar Road","Mahaveer Nagar","Mahaveer Colony","Mahindra World City",
    "Nirman Nagar","Nuniyan","Panchyawala","Ram Nagar","Shastri Nagar","Shyam Nagar","Tilak Nagar",
    "Triveni Nagar","New Sanganer Road","Agrawal Farm","Brahmachari Nagar","Bapu Nagar Extension"
  ];

  let DATA = [];
  const now = new Date();
  elUpdated.textContent = "Last updated: " + now.toLocaleString();

  // ---------------- Fetch data ----------------
  fetch('data/listings.json?_=' + Date.now())
    .then(r => r.json())
    .then(json => {
      DATA = Array.isArray(json) ? json : [];
      populateLocalities(DATA);
      render();
    })
    .catch(() => { DATA = []; populateLocalities([]); render(); });

  // ---------------- Populate locality dropdown ----------------
  function populateLocalities(rows){
    const set = new Set(JAIPUR_COLONIES);
    rows.forEach(r => { if (r.locality) set.add(r.locality); });
    const options = ['<option value="">All Localities</option>'];
    [...set].sort().forEach(loc => options.push(`<option>${loc}</option>`));
    elLoc.innerHTML = options.join('');
  }

  // ---------------- Events ----------------
  // small debounce for typing
  let t=null;
  elQ.addEventListener('input', ()=>{
    clearTimeout(t); t=setTimeout(render, 150);
  });
  [elLoc, elType, elPrice].forEach(el => el.addEventListener('change', render));
  elGo.addEventListener('click', render);
  elReset.addEventListener('click', ()=>{
    elQ.value=''; elLoc.value=''; elType.value=''; elPrice.value='';
    render();
  });

  // ---------------- Helpers ----------------
  function money(v){ return v ? "₹" + Number(v).toLocaleString() : "-"; }
  function matches(d){
    const q   = (elQ.value||'').toLowerCase();
    const loc = elLoc.value;
    const typ = elType.value;
    const pb  = elPrice.value;

    if(q){
      const hay = `${d.title||''} ${d.locality||''} ${d.bank||''} ${d.type||''}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(loc && (d.locality||'') !== loc) return false;
    if(typ && (d.type||'') !== typ) return false;
    if(pb){
      const [lo,hi] = pb.split('-').map(Number);
      const rp = Number(d.reserve_price||0);
      if(!(rp>=lo && rp<=hi)) return false;
    }
    return true;
  }

  // ---------------- Render ----------------
  function render(){
    markersLayer.clearLayers();
    elList.innerHTML = '';

    const rows = DATA.filter(matches);
    elCount.textContent = `${rows.length} result${rows.length===1?'':'s'}`;

    if(rows.length === 0){
      const empty = document.createElement('div');
      empty.className = 'card';
      empty.innerHTML = '<b>No results</b><div class="muted">Try clearing filters or widening price/type.</div>';
      elList.appendChild(empty);
      return;
    }

    rows.forEach(d=>{
      if(d.lat && d.lng){
        const m = L.marker([d.lat, d.lng]).addTo(markersLayer);
        m.bindPopup(
          `<b>${d.title||''}</b><br>${d.locality||''}<br>
           Reserve: ${money(d.reserve_price)}<br>
           Auction: ${d.auction_date||'-'}<br>
           <a target="_blank" href="${d.source||'#'}">Source</a>`
        );
      }
      const rp = money(d.reserve_price);
      const emd = money(d.emd);
      const adt = d.auction_date || '-';

      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
          <div>
            <b>${d.title||''}</b> <span class="badge">${d.type||'Property'}</span>
            <div>${d.address||''}</div>
            <div>${d.locality||''}</div>
            <div>Bank: ${d.bank||'-'}</div>
          </div>
          <div style="text-align:right;min-width:180px">
            <div><b>${rp}</b></div>
            <div>Auction: ${adt}</div>
            <div>EMD: ${emd}</div>
            <a target="_blank" href="${d.source||'#'}">Open notice</a>
          </div>
        </div>`;
      elList.appendChild(card);
    });
  }
});
</script>
</body>
</html>
